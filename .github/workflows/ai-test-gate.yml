name: AI Test Generation Gate

on:
  pull_request:
    types: [opened, synchronize] 

jobs:
  ai_verification:
    runs-on: ubuntu-latest
    permissions:
      contents: read 
      pull-requests: write 
      
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      - name: Set up Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'
      - name: Install Dependencies (Including Anthropic SDK)
        run: pip install anthropic pytest pytest-cov 
      - name: Get Pull Request Diff
        id: pr_diff
        run: |
          DIFF_CONTENT=$(gh pr diff ${{ github.event.pull_request.number }} --patch --repo ${{ github.repository }})
          echo "PR_DIFF<<EOF" >> $GITHUB_ENV
          echo "$DIFF_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Execute AI Test Generation Script
        run: python generate_tests.py
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          PR_DIFF: ${{ env.PR_DIFF }}
      
      - name: Extract Raw Python Code
        run: |
          python -c "
          import re
          with open('claude_output.txt', 'r') as f:
              content = f.read()
          # Remove markdown code fences
          content = re.sub(r'\`\`\`python\n?', '', content)
          content = re.sub(r'\`\`\`\n?', '', content)
          with open('ai_generated_tests.py', 'w') as f:
              f.write(content)
          "
      
      - name: Debug - Check Generated Files
        run: |
          echo "=== Contents of claude_output.txt ==="
          cat claude_output.txt
          echo ""
          echo "=== Contents of ai_generated_tests.py ==="
          cat ai_generated_tests.py
          echo ""
          echo "=== List all test files ==="
          find . -name "*test*.py" -o -name "test_*.py"
          
      - name: Run Tests
        run: |
          pytest ai_generated_tests.py -v --cov --cov-report=xml --junitxml=results.xml || true

      - name: Post Coverage Summary to PR
        uses: MishaKav/pytest-coverage-comment@main 
        with:
          coverage-xml-path: coverage.xml
          minimum-coverage: 75 
          github-token: ${{ secrets.GITHUB_TOKEN }}
